"use strict";(self.webpackChunknodejs_mobile_docs=self.webpackChunknodejs_mobile_docs||[]).push([[904],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>h});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=o.createContext({}),d=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=d(e.components);return o.createElement(p.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),c=d(n),m=r,h=c["".concat(p,".").concat(m)]||c[m]||u[m]||a;return n?o.createElement(h,i(i({ref:t},l),{},{components:n})):o.createElement(h,i({ref:t},l))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=m;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[c]="string"==typeof e?e:r,i[1]=s;for(var d=2;d<a;d++)i[d]=n[d];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},2698:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var o=n(7462),r=(n(7294),n(3905));const a={sidebar_position:2,title:"Building complex projects"},i=void 0,s={unversionedId:"guide/guide-android/building-complex",id:"guide/guide-android/building-complex",title:"Building complex projects",description:"This guide will show you how to start the node runtime from a project folder on Android. It builds on top of the Android Getting Started instructions, having the same functionality but using a nodejs-project folder that contains the Node part of the project. It also shows how to use an npm module in the project.",source:"@site/docs/guide/guide-android/building-complex.md",sourceDirName:"guide/guide-android",slug:"/guide/guide-android/building-complex",permalink:"/docs/guide/guide-android/building-complex",draft:!1,editUrl:"https://github.com/nodejs-mobile/nodejs-mobile.github.io/tree/main/docs/guide/guide-android/building-complex.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Building complex projects"},sidebar:"docs",previous:{title:"Getting started",permalink:"/docs/guide/guide-android/getting-started"},next:{title:"Redirect output streams to logcat",permalink:"/docs/guide/guide-android/redirect-to-logcat"}},p={},d=[{value:"Create the <code>nodejs-project</code> folder",id:"create-the-nodejs-project-folder",level:3},{value:"Add a npm module to the <code>nodejs-project</code>",id:"add-a-npm-module-to-the-nodejs-project",level:3},{value:"Copy the <code>nodejs-project</code> at runtime and start from there",id:"copy-the-nodejs-project-at-runtime-and-start-from-there",level:3},{value:"Copy the nodejs-project only after an APK change",id:"copy-the-nodejs-project-only-after-an-apk-change",level:3}],l={toc:d},c="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,o.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This guide will show you how to start the node runtime from a project folder on Android. It builds on top of the ",(0,r.kt)("a",{parentName:"p",href:"/docs/guide/guide-android/getting-started"},"Android Getting Started")," instructions, having the same functionality but using a ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," folder that contains the Node part of the project. It also shows how to use an npm module in the project."),(0,r.kt)("p",null,"The complete project can also be downloaded ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nodejs-mobile/nodejs-mobile-samples"},"from the samples repo"),"."),(0,r.kt)("h3",{id:"create-the-nodejs-project-folder"},"Create the ",(0,r.kt)("inlineCode",{parentName:"h3"},"nodejs-project")," folder"),(0,r.kt)("p",null,"Create a ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," folder inside the project, in Gradle's default folder for Android's application assets ( ",(0,r.kt)("inlineCode",{parentName:"p"},"app/src/main/assets/nodejs-project")," ). Create the ",(0,r.kt)("inlineCode",{parentName:"p"},"main.js")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," files as:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="app/src/main/assets/nodejs-project/main.js"',title:'"app/src/main/assets/nodejs-project/main.js"'},"const http = require('http');\nconst versions_server = http.createServer( (request, response) => {\n  response.end('Versions: ' + JSON.stringify(process.versions));\n});\nversions_server.listen(3000);\nconsole.log('The node project has started.');\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="app/src/main/assets/nodejs-project/package.json"',title:'"app/src/main/assets/nodejs-project/package.json"'},'{\n  "name": "native-gradle-node-project",\n  "version": "0.0.1",\n  "description": "node part of the project",\n  "main": "main.js",\n  "author": "me",\n  "license": ""\n}\n')),(0,r.kt)("h3",{id:"add-a-npm-module-to-the-nodejs-project"},"Add a npm module to the ",(0,r.kt)("inlineCode",{parentName:"h3"},"nodejs-project")),(0,r.kt)("p",null,"Having a ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," path with a ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," inside is helpful for using npm modules, by running ",(0,r.kt)("inlineCode",{parentName:"p"},"npm install {module_name}")," inside ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," so that the modules are also packaged with the application and made available at runtime."),(0,r.kt)("p",null,"Install the ",(0,r.kt)("inlineCode",{parentName:"p"},"left-pad")," module, by running npm ",(0,r.kt)("inlineCode",{parentName:"p"},"install left-pad")," inside the ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," folder."),(0,r.kt)("p",null,"Update ",(0,r.kt)("inlineCode",{parentName:"p"},"main.js")," to use the module:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="app/src/main/assets/nodejs-project/main.js"',title:'"app/src/main/assets/nodejs-project/main.js"'},"const http = require('http');\n// highlight-next-line\nconst leftPad = require('left-pad');\nconst versions_server = http.createServer( (request, response) => {\n// highlight-next-line\n  response.end('Versions: ' + JSON.stringify(process.versions) + ' left-pad: ' + leftPad(42, 5, '0'));\n});\nversions_server.listen(3000);\n")),(0,r.kt)("h3",{id:"copy-the-nodejs-project-at-runtime-and-start-from-there"},"Copy the ",(0,r.kt)("inlineCode",{parentName:"h3"},"nodejs-project")," at runtime and start from there"),(0,r.kt)("p",null,"To start the Node.js engine runtime with a file path, we need to first copy the project to somewhere in the Android file system, because the Android Application's APK is an archive file and Node.js won't be able to start running from there. For this purpose, we choose to copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," into the Application's ",(0,r.kt)("inlineCode",{parentName:"p"},"FilesDir"),"."),(0,r.kt)("p",null,"Add the helper functions to ",(0,r.kt)("inlineCode",{parentName:"p"},"app/src/main/java/com/yourorg/sample/MainActivity.java"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'import android.content.Context;\nimport android.content.res.AssetManager;\n\n//...\n\n    private static boolean deleteFolderRecursively(File file) {\n        try {\n            boolean res=true;\n            for (File childFile : file.listFiles()) {\n                if (childFile.isDirectory()) {\n                    res &= deleteFolderRecursively(childFile);\n                } else {\n                    res &= childFile.delete();\n                }\n            }\n            res &= file.delete();\n            return res;\n        } catch (Exception e) {\n            e.printStackTrace();\n            return false;\n        }\n    }\n\n    private static boolean copyAssetFolder(AssetManager assetManager, String fromAssetPath, String toPath) {\n        try {\n            String[] files = assetManager.list(fromAssetPath);\n            boolean res = true;\n\n            if (files.length==0) {\n                //If it\'s a file, it won\'t have any assets "inside" it.\n                res &= copyAsset(assetManager,\n                        fromAssetPath,\n                        toPath);\n            } else {\n                new File(toPath).mkdirs();\n                for (String file : files)\n                res &= copyAssetFolder(assetManager,\n                        fromAssetPath + "/" + file,\n                        toPath + "/" + file);\n            }\n            return res;\n        } catch (Exception e) {\n            e.printStackTrace();\n            return false;\n        }\n    }\n\n    private static boolean copyAsset(AssetManager assetManager, String fromAssetPath, String toPath) {\n        InputStream in = null;\n        OutputStream out = null;\n        try {\n            in = assetManager.open(fromAssetPath);\n            new File(toPath).createNewFile();\n            out = new FileOutputStream(toPath);\n            copyFile(in, out);\n            in.close();\n            in = null;\n            out.flush();\n            out.close();\n            out = null;\n            return true;\n        } catch(Exception e) {\n            e.printStackTrace();\n            return false;\n        }\n    }\n\n    private static void copyFile(InputStream in, OutputStream out) throws IOException {\n        byte[] buffer = new byte[1024];\n        int read;\n        while ((read = in.read(buffer)) != -1) {\n            out.write(buffer, 0, read);\n        }\n    }\n')),(0,r.kt)("p",null,"Before starting the Node runtime, delete the previous ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," and copy the current one into the ",(0,r.kt)("inlineCode",{parentName:"p"},"FilesDir")," and start the runtime from there:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'            new Thread(new Runnable() {\n                @Override\n                public void run() {\n                    //The path where we expect the node project to be at runtime.\n                    String nodeDir=getApplicationContext().getFilesDir().getAbsolutePath()+"/nodejs-project";\n                    //Recursively delete any existing nodejs-project.\n                    File nodeDirReference=new File(nodeDir);\n                    if (nodeDirReference.exists()) {\n                        deleteFolderRecursively(new File(nodeDir));\n                    }\n                    //Copy the node project from assets into the application\'s data path.\n                    copyAssetFolder(getApplicationContext().getAssets(), "nodejs-project", nodeDir);\n                    startNodeWithArguments(new String[]{"node",\n                            nodeDir+"/main.js"\n                    });\n                }\n            }).start();\n')),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Given the project folder can be overwritten, it should not be used for persistent data storage.")),(0,r.kt)("h3",{id:"copy-the-nodejs-project-only-after-an-apk-change"},"Copy the nodejs-project only after an APK change"),(0,r.kt)("p",null,"Recopying the ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," at each Application's run can be expensive, so improve it by saving the last time the APK was updated on an Application Shared Preference and check if we need to delete and copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project"),"."),(0,r.kt)("p",null,"Add the helper functions to ",(0,r.kt)("inlineCode",{parentName:"p"},"app/src/main/java/com/yourorg/sample/MainActivity.java"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'import android.content.pm.PackageInfo;\nimport android.content.pm.PackageManager;\nimport android.content.SharedPreferences;\n\n//...\n\n    private boolean wasAPKUpdated() {\n        SharedPreferences prefs = getApplicationContext().getSharedPreferences("NODEJS_MOBILE_PREFS", Context.MODE_PRIVATE);\n        long previousLastUpdateTime = prefs.getLong("NODEJS_MOBILE_APK_LastUpdateTime", 0);\n        long lastUpdateTime = 1;\n        try {\n            PackageInfo packageInfo = getApplicationContext().getPackageManager().getPackageInfo(getApplicationContext().getPackageName(), 0);\n            lastUpdateTime = packageInfo.lastUpdateTime;\n        } catch (PackageManager.NameNotFoundException e) {\n            e.printStackTrace();\n        }\n        return (lastUpdateTime != previousLastUpdateTime);\n    }\n\n    private void saveLastUpdateTime() {\n        long lastUpdateTime = 1;\n        try {\n            PackageInfo packageInfo = getApplicationContext().getPackageManager().getPackageInfo(getApplicationContext().getPackageName(), 0);\n            lastUpdateTime = packageInfo.lastUpdateTime;\n        } catch (PackageManager.NameNotFoundException e) {\n            e.printStackTrace();\n        }\n        SharedPreferences prefs = getApplicationContext().getSharedPreferences("NODEJS_MOBILE_PREFS", Context.MODE_PRIVATE);\n        SharedPreferences.Editor editor = prefs.edit();\n        editor.putLong("NODEJS_MOBILE_APK_LastUpdateTime", lastUpdateTime);\n        editor.commit();\n    }\n')),(0,r.kt)("p",null,"Change the code that starts the node runtime to check if it needs to delete the previous ",(0,r.kt)("inlineCode",{parentName:"p"},"nodejs-project")," and copy the current one into the ",(0,r.kt)("inlineCode",{parentName:"p"},"FilesDir"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'            new Thread(new Runnable() {\n                @Override\n                public void run() {\n                    //The path where we expect the node project to be at runtime.\n                    String nodeDir=getApplicationContext().getFilesDir().getAbsolutePath()+"/nodejs-project";\n                    if (wasAPKUpdated()) {\n                        //Recursively delete any existing nodejs-project.\n                        File nodeDirReference=new File(nodeDir);\n                        if (nodeDirReference.exists()) {\n                            deleteFolderRecursively(new File(nodeDir));\n                        }\n                        //Copy the node project from assets into the application\'s data path.\n                        copyAssetFolder(getApplicationContext().getAssets(), "nodejs-project", nodeDir);\n\n                        saveLastUpdateTime();\n                    }\n                    startNodeWithArguments(new String[]{"node",\n                            nodeDir+"/main.js"\n                    });\n                }\n            }).start();\n')),(0,r.kt)("p",null,"The sample for this guide also contains code to redirect Node's output to logcat, which can be included by following the ",(0,r.kt)("a",{parentName:"p",href:"/docs/guide/guide-android/redirect-to-logcat"},"Redirect output streams to logcat")," guide."))}u.isMDXComponent=!0}}]);